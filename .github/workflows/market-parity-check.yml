name: Market Parity Check

# Automated checks to ensure AllFrame maintains feature parity
# with market leaders (tonic, async-graphql, axum)

on:
  schedule:
    # Run monthly to track feature parity
    - cron: '0 9 1 * *'  # First day of month, 9 AM UTC
  workflow_dispatch:  # Allow manual triggers

jobs:
  check-graphql-features:
    name: GraphQL Feature Parity
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check async-graphql version
        id: graphql-version
        run: |
          CURRENT=$(cargo metadata --format-version=1 | jq -r '.packages[] | select(.name=="async-graphql") | .version')
          LATEST=$(cargo search async-graphql --limit 1 | head -1 | awk '{print $3}' | tr -d '"')
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

      - name: Report GraphQL version status
        run: |
          echo "Current async-graphql: ${{ steps.graphql-version.outputs.current }}"
          echo "Latest async-graphql: ${{ steps.graphql-version.outputs.latest }}"

          if [ "${{ steps.graphql-version.outputs.current }}" != "${{ steps.graphql-version.outputs.latest }}" ]; then
            echo "âš ï¸ async-graphql update available"
          else
            echo "âœ… async-graphql is up to date"
          fi

  check-grpc-features:
    name: gRPC Feature Parity
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check tonic version
        id: tonic-version
        run: |
          CURRENT=$(cargo metadata --format-version=1 | jq -r '.packages[] | select(.name=="tonic") | .version')
          LATEST=$(cargo search tonic --limit 1 | head -1 | awk '{print $3}' | tr -d '"')
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

      - name: Check prost version
        id: prost-version
        run: |
          CURRENT=$(cargo metadata --format-version=1 | jq -r '.packages[] | select(.name=="prost") | .version')
          LATEST=$(cargo search prost --limit 1 | head -1 | awk '{print $3}' | tr -d '"')
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

      - name: Report gRPC version status
        run: |
          echo "Current tonic: ${{ steps.tonic-version.outputs.current }}"
          echo "Latest tonic: ${{ steps.tonic-version.outputs.latest }}"
          echo "Current prost: ${{ steps.prost-version.outputs.current }}"
          echo "Latest prost: ${{ steps.prost-version.outputs.latest }}"

  feature-coverage-report:
    name: Feature Coverage Report
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Generate feature report
        run: |
          cat << 'EOF' > feature-report.md
          # AllFrame Market Parity Report

          Generated: $(date)

          ## GraphQL Features

          | Feature | AllFrame | async-graphql | Status |
          |---------|----------|---------------|--------|
          | AST Parsing | âœ… | âœ… | âœ… Parity |
          | Queries | âœ… | âœ… | âœ… Parity |
          | Mutations | âœ… | âœ… | âœ… Parity |
          | Subscriptions | âœ… | âœ… | âœ… Parity |
          | GraphiQL | âœ… | âœ… | âœ… Parity |
          | Schema Introspection | âœ… | âœ… | âœ… Parity |
          | Custom Scalars | ðŸš§ | âœ… | âš ï¸ Planned |
          | Federation | ðŸš§ | âœ… | âš ï¸ Planned |

          ## gRPC Features

          | Feature | AllFrame | tonic | Status |
          |---------|----------|-------|--------|
          | Unary RPCs | âœ… | âœ… | âœ… Parity |
          | Server Streaming | âœ… | âœ… | âœ… Parity |
          | Client Streaming | âœ… | âœ… | âœ… Parity |
          | Bidirectional Streaming | âœ… | âœ… | âœ… Parity |
          | Reflection API | âœ… | âœ… | âœ… Parity |
          | Protobuf Encoding | âœ… | âœ… | âœ… Parity |
          | HTTP/2 | âœ… | âœ… | âœ… Parity |
          | Compression | ðŸš§ | âœ… | âš ï¸ Planned |
          | Health Checking | ðŸš§ | âœ… | âš ï¸ Planned |

          ## AllFrame Unique Features

          | Feature | Status |
          |---------|--------|
          | Multi-Protocol Routing | âœ… |
          | Config-Driven Protocol Selection | âœ… |
          | Protocol-Agnostic Handlers | âœ… |
          | Compile-Time DI | âœ… |
          | Auto OpenAPI Generation | âœ… |

          ## Recommendations

          - âœ… = Feature parity achieved
          - ðŸš§ = Planned for future milestone
          - âš ï¸ = Investigate for inclusion

          EOF
          cat feature-report.md

      - name: Upload feature report
        uses: actions/upload-artifact@v4
        with:
          name: feature-parity-report
          path: feature-report.md

  create-tracking-issue:
    name: Create Tracking Issue
    runs-on: ubuntu-latest
    needs: [check-graphql-features, check-grpc-features, feature-coverage-report]
    if: always()
    steps:
      - name: Check for existing tracking issue
        id: check-issue
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'market-parity',
              state: 'open'
            });
            return issues.data.length > 0;

      - name: Create or update tracking issue
        if: steps.check-issue.outputs.result == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Market Parity Check - ${date}`,
              body: `# Market Parity Status Report

              This issue tracks AllFrame's feature parity with market leaders.

              ## Dependencies Status

              Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

              ## Action Items

              - [ ] Review dependency versions
              - [ ] Evaluate new features from async-graphql
              - [ ] Evaluate new features from tonic
              - [ ] Update feature parity documentation

              ## Next Check

              Automated check will run again next month.`,
              labels: ['market-parity', 'tracking', 'dependencies']
            });
